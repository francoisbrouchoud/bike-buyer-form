<div class="card">
  <h1>Données du client</h1>
  <p class="subtitle">Veuillez remplir les données ci-dessous pour prédire l’achat de vélo.</p>

  <!-- Profil -->
  <h2><mat-icon>person</mat-icon> Profil</h2>
  <mat-divider></mat-divider>

  <form [formGroup]="form" (ngSubmit)="submit()" class="grid">
    <mat-form-field appearance="outline">
      <mat-label>Langue</mat-label>
      <mat-select formControlName="language">
        <mat-option *ngFor="let l of languageOptions" [value]="l">{{ l }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Genre</mat-label>
      <mat-select formControlName="gender">
        <mat-option *ngFor="let g of genders" [value]="g.value">{{ g.key }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Prénom</mat-label>
      <input matInput formControlName="firstName">
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Nom</mat-label>
      <input matInput formControlName="lastName">
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Date de naissance</mat-label>
      <input matInput
            [matDatepicker]="picker"
            formControlName="birthDate">
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Taille [cm]</mat-label>
      <input matInput type="number" formControlName="height">
      <mat-error *ngIf="form.get('height')?.errors?.['min']">Min 100 cm</mat-error>
      <mat-error *ngIf="form.get('height')?.errors?.['max']">Max 275 cm</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Statut marital</mat-label>
      <mat-select formControlName="maritalStatus">
        <mat-option *ngFor="let m of maritals" [value]="m.value">{{ m.key }}</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Contact -->
    <div class="section col-2">
      <h2><mat-icon>mail</mat-icon> Contact</h2>
      <mat-divider></mat-divider>
    </div>

    <mat-form-field appearance="outline" class="col-2">
      <mat-label>Adresse e-mail</mat-label>
      <input matInput type="email" formControlName="emailAddress" autocomplete="email">
      <mat-error *ngIf="form.controls.emailAddress.hasError('pattern')">
        Adresse e‑mail invalide
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="col-2">
      <mat-label>Téléphone</mat-label>
      <input matInput type="tel" formControlName="phoneNumber" autocomplete="tel">
      <mat-error *ngIf="form.controls.phoneNumber.hasError('pattern')">
        Numéro de téléphone invalide
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Abonnement à la newsletter</mat-label>
      <mat-select formControlName="emailPromotion">
        <mat-option *ngFor="let opt of emailPromoOptions" [value]="opt.value">
          {{ opt.key }}
        </mat-option>
      </mat-select>
    </mat-form-field>


    <div class="section col-2">
      <h2><mat-icon>home</mat-icon>Adresse</h2>
      <mat-divider></mat-divider>
    </div>

    <mat-form-field appearance="outline">
      <mat-label>Pays</mat-label>
      <mat-select formControlName="country">
        <mat-option *ngFor="let c of countries" [value]="c.value">{{ c.key }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Code postal</mat-label>
      <input matInput formControlName="zip" inputmode="numeric" autocomplete="postal-code">
    </mat-form-field>

    <mat-form-field appearance="outline" class="col-2">
      <mat-label>Localité</mat-label>
      <input
        matInput
        formControlName="city"
        [matAutocomplete]="autoCity"
        [matAutocompleteDisabled]="!isCH"
        autocomplete="address-level2">
    </mat-form-field>

    <mat-autocomplete #autoCity="matAutocomplete" (optionSelected)="onCitySelected($event.option.value)">
      <mat-option *ngFor="let o of (cityOptions$ | async)" [value]="o">
        {{ o.zip }} {{ o.city }} <ng-container *ngIf="o.canton">({{ o.canton }})</ng-container>
      </mat-option>
    </mat-autocomplete>
    <mat-form-field appearance="outline" class="col-2">
      <mat-label>Rue</mat-label>
      <input
        matInput
        formControlName="street"
        [matAutocomplete]="autoAddr"
        [matAutocompleteDisabled]="!isCH"
        autocomplete="address-line1">
    </mat-form-field>

    <mat-autocomplete #autoAddr="matAutocomplete">
      <mat-option
        *ngFor="let a of (addressOptions$ | async)"
        [value]="a.street"
        (onSelectionChange)="a && $event.isUserInput && onAddressSelected(a)">
        {{ a.street }}
      </mat-option>
    </mat-autocomplete>

    <mat-form-field appearance="outline">
      <mat-label>{{ isCH ? 'Canton' : 'État / Région' }}</mat-label>
      <input
        matInput
        formControlName="state"
        [readonly]="isCH"
        [placeholder]="isCH ? 'Défini via la localité' : ''">
    </mat-form-field>
     <!-- Ménage & revenus -->
    <div class="section col-2">
      <h2><mat-icon>account_balance_wallet</mat-icon> Ménage et revenu</h2>
      <mat-divider></mat-divider>
    </div>

    <mat-form-field appearance="outline">
      <mat-label>Revenu annuel</mat-label>
      <mat-select formControlName="yearlyIncome">
        <mat-option *ngFor="let b of incomeOptions" [value]="b.value">
          {{ b.key }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-checkbox formControlName="homeOwner">Propriétaire de son logement</mat-checkbox>

    <mat-form-field appearance="outline">
      <mat-label>Nombre de voitures</mat-label>
      <input matInput type="number" formControlName="numberCarsOwned">
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Nombre total d’enfants</mat-label>
      <input matInput type="number" formControlName="totalChildren">
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Enfants à la maison</mat-label>
      <input matInput type="number" formControlName="totalChildrenAtHome">
    </mat-form-field>

    <!-- Éducation / Profession -->
    <div class="section col-2">
      <h2><mat-icon>school</mat-icon> Éducation et profession</h2>
      <mat-divider></mat-divider>
    </div>

    <mat-form-field appearance="outline">
      <mat-label>Niveau d’éducation</mat-label>
      <mat-select formControlName="education">
        <mat-option *ngFor="let e of educationOptions" [value]="e.value">{{ e.value }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Profession</mat-label>
      <mat-select formControlName="occupation">
        <mat-option *ngFor="let o of occupationOptions" [value]="o.value">{{ o.value }}</mat-option>
      </mat-select>
    </mat-form-field>

    <div class="actions col-2">
      <button mat-flat-button color="primary" type="submit" [disabled]="loading">
        <mat-icon>pedal_bike</mat-icon>
        Prédire l’achat de vélo
      </button>
    </div>
  </form>

  <div class="result" *ngIf="loading || result">
  <div class="loading" *ngIf="loading">
    <mat-progress-spinner mode="indeterminate" diameter="22"></mat-progress-spinner>
    Prediction en cours...
  </div>
  <div *ngIf="!loading && result">
    <span class="chip" [class.ok]="result.ok" [class.ko]="!result.ok">
      <mat-icon>{{ result.ok ? 'check_circle' : 'cancel' }}</mat-icon>
      {{ result.ok ? 'BikeBuyer: Yes' : 'BikeBuyer: No' }}
    </span>

    <div *ngIf="result.percentile != null">
      <span class="chip">
      <mat-icon>info</mat-icon> Pourcentage : {{ result.percentile }} % 
      </span>
    </div>

    <div *ngIf="result.probTrue != null && result.probFalse != null">
      <span class="chip">
      <mat-icon>insights</mat-icon> 
      p(true): {{ result.probTrue | number:'1.0-3' }} | p(false): {{ result.probFalse | number:'1.0-3' }}
      </span>
    </div>
  </div>
</div>
